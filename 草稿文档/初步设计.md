QK Chat App（Qt 6）
功能：
1.登录认证
2.好友聊天
3.群聊
4.文件传输

注：目前客户端和服务器端都暂时在同一台本地计算机进行开发和测试（以后服务器端将会部署在远程服务器上）


服务器端
| 组件         | 技术选型                     | 说明                                                                 |
|--------------|-----------------------------|----------------------------------------------------------------------|
| 网络通信     | `QSslServer`                | **⚠️ 替换QTcpServer**，支持TLS 1.3加密通信，证书自动续期机制            |
| 协议解析     | 自定义二进制协议解析器        | 包头结构优化：**✅ 增加心跳标志位(1B)** + 消息类型(2B) + 消息长度(4B) + 消息体 |
| 数据库       | MySQL + QtSql模块           | 表结构增强：<br>- 用户表 **✅ 增加last_online字段**<br>- 消息表 **✅ 增加delivery_status状态字段** |
| 加密         | `QCryptographicHash(SHA-256)` + **✅ OpenSSL** | **⚠️ 强制启用TLS**，采用ECDHE-RSA-AES256-GCM加密套件                 |
| 文件传输     | 独立`QSslServer`端口        | **✅ 增加区块索引表**记录传输进度，**⚠️ 支持零拷贝(QFile::map)**         |
| 多线程       | `QThreadPool` + 任务队列     | **⚠️ 设置线程上限**：`QThreadPool::setMaxThreadCount(CPU核心数×2 + 1)` |


客户端
| 组件         | 技术选型                     | 说明                                                                 |
|--------------|-----------------------------|----------------------------------------------------------------------|
| 网络层       | `QSslSocket`                | **⚠️ 替换QTcpSocket**，自动验证服务器证书链                          |
| UI框架       | QWidget + QML               | **✅ 新增心跳计时器**：30秒无活动触发自动重连                        |
| 数据缓存     | SQLiteCipher加密            | **✅ 增加缓存淘汰策略**：LRU自动清理90天前旧消息                     |
| 文件传输     | 分块校验(MD5) + 断点续传     | **⚠️ 集成区块索引持久化**，意外退出后可恢复传输                      |
| 多线程       | `QFuture` + `QtConcurrent`  | **✅ 增加传输带宽限制器**：防止大文件占用全部网络带宽                |

QK_Chat_App/                     # 项目根目录
├── client/                      # 客户端项目
│   ├── src/                     # 源代码
│   │   ├── main.cpp             # 主入口
│   │   ├── network/             # 网络模块
│   │   │   ├── ChatClient.cpp   # 通信核心
│   │   │   └── FileTransfer.cpp # 文件传输
│   │   ├── ui/                  # 界面层
│   │   │   ├── LoginWidget.cpp  # 登录界面
│   │   │   └── ChatWindow.cpp   # 聊天主界面
│   │   └── database/            # 数据模块
│   │       └── LocalCache.cpp   # SQLite管理
│   ├── resources/               # 资源文件
│   │   ├── qml/                 # QML组件
│   │   │   ├── MessageBubble.qml
│   │   │   └── ContactList.qml
│   │   └── icons/               # 图标资源
│   ├── config/                  # 配置中心
│   │   ├── dev.ini              # 开发环境配置
│   │   └── config_loader.cpp    # 配置加载器
│   ├── database/                # 本地数据库存储
│   │   └── local_cache.db       # SQLite数据库文件
│   └── CMakeLists.txt           # 构建配置
│
├── server/                      # 服务端项目
│   ├── src/                     # 源代码
│   │   ├── main.cpp             # 主入口
│   │   ├── core/                # 核心逻辑
│   │   │   ├── ChatServer.cpp   # 服务主类
│   │   │   └── SessionManager.cpp # 会话管理
│   │   ├── network/             # 网络模块
│   │   │   ├── SecureServer.cpp # SSL服务器
│   │   │   └── ProtocolParser.cpp # 协议解析
│   │   └── database/            # 数据模块
│   │       └── Database.cpp     # MySQL操作
│   ├── config/                  # 配置中心
│   │   ├── dev.conf             # 开发环境配置
│   │   └── certs/               # TLS证书（开发用）
│   │       ├── server.crt       # 自签名证书
│   │       └── server.key       # 私钥
│   ├── data/                    # 数据存储
│   │   ├── files/               # 上传文件存储
│   │   └── mysql_init.sql       # 数据库初始化脚本
│   └── CMakeLists.txt           # 构建配置
│
├── common/                      # 公共资源
│   ├── protocol/                # 协议定义
│   │   └── chat.proto           # Protobuf协议文件
│   └── crypto/                  # 加密工具
│       └── CryptoUtils.cpp      # 加解密实现
│
├── scripts/                     # 实用脚本
│   ├── init_local_db.sh         # 初始化本地MySQL
│   └── gen_cert.sh              # 生成开发证书
│
└── docker-compose.yml           # 本地开发环境容器配置


客户端架构设计
分层架构
├── 表现层(Presentation)
│   ├── QWidget界面框架  # 核心聊天窗口
│   └── QML动态界面     # 响应式布局
│
├── 业务层(Business Logic)
│   ├── 消息处理器      # 编解码/加密/解密
│   ├── 文件传输引擎    # 分块/校验/续传
│   └── 状态管理机      # 登录/连接/断网恢复
│
├── 服务层(Services)
│   ├── 网络服务        # QSslSocket管理
│   ├── 存储服务        # SQLiteCipher
│   └── 推送服务        # 本地通知
│
└── 基础设施(Infrastructure)
    ├── 配置管理        # INI解析器
    ├── 日志系统        # 分级日志
    └── 异常处理        # 崩溃报告

核心模块交互
sequenceDiagram
    participant UI as 用户界面
    participant BL as 业务逻辑
    participant Net as 网络服务
    participant DB as 本地存储
    
    UI->>BL: 发送消息请求
    BL->>DB: 消息写入缓存(SQLite)
    BL->>Net: 封装协议并发送
    Net-->>BL: 接收服务器ACK
    BL->>DB: 更新消息状态(delivery_status)
    BL->>UI: 刷新消息状态


服务器端架构设计
微服务化架构
├── 接入网关(Gateway)
│   ├── QSslServer实例    # 10k连接/实例
│   ├── 协议适配器        # 二进制协议解析
│   └── 负载均衡器        # 连接分发
│
├── 核心服务(Core Services)
│   ├── 会话服务          # 用户在线状态管理
│   ├── 消息路由          # 一对一/群聊消息分发
│   ├── 文件服务          # 分块存储/校验
│   └── 推送服务          # 离线消息缓存
│
├── 数据层(Data Layer)
│   ├── MySQL访问层       # 分库分表代理
│   ├── Redis缓存代理     # 会话/热点数据
│   └── S3存储适配器      # 文件存储抽象
│
└── 支撑系统(Supporting)
    ├── 配置中心          # etcd动态配置
    ├── 监控系统          # Prometheus指标
    └── 日志收集          # ELK栈

关键业务流程 - 消息投递
sequenceDiagram
    participant C as Client
    participant G as Gateway
    participant S as SessionService
    participant M as MessageService
    participant D as Database
    
    C->>G: 发送消息(协议封装)
    G->>S: 查询接收方状态
    alt 在线
        S->>M: 实时投递
        M->>D: 写消息记录
        M-->>C: 返回ACK
    else 离线
        S->>D: 存入离线消息
        D-->>G: 存储确认
        G-->>C: 返回ACK
    end


服务间接口
| 服务          | 接口协议       | 端口   | 说明                     |
|---------------|---------------|--------|--------------------------|
| 网关→会话服务 | gRPC          | 50051  | 实时查询用户连接节点     |
| 消息→存储     | MySQL协议     | 3306   | 消息持久化               |
| 文件→对象存储 | S3 REST API   | 9000   | MinIO兼容接口            |
| 监控数据      | Prometheus    | 9090   | 指标采集                 |


### 客户端设计模式

1. **MVVM（Model-View-ViewModel）模式**：
   - **Model**：代表数据和业务逻辑（如消息列表、联系人列表）。
   - **View**：由QML实现的用户界面，负责展示数据。
   - **ViewModel**：作为Model和View之间的桥梁，将Model的数据暴露给View，并处理View的交互逻辑。

2. **观察者模式**：
   - 用于实现事件通知机制，例如当收到新消息时，通知各个界面更新。

3. **单例模式**：
   - 用于管理全局唯一的对象，如网络连接管理器、用户配置等。

4. **工厂模式**：
   - 用于创建不同类型的消息对象（文本、图片、文件等）。


### 客户端线程池设计

客户端采用Qt的`QThreadPool`和`QRunnable`来管理并发任务。设计如下：

- **主线程**：负责UI渲染和事件处理。
- **网络线程**：使用线程池处理网络请求（发送消息、文件传输等），避免阻塞UI。
- **数据库线程**：使用单独的线程进行本地SQLite数据库操作。


### 服务器端设计模式

1. **Reactor模式**：
   - 使用Qt的`QSocketNotifier`或第三方库（如Boost.Asio）实现事件驱动，处理大量并发连接。

2. **策略模式**：
   - 用于不同的消息处理策略（如文本消息、文件消息、命令消息等）。

3. **抽象工厂模式**：
   - 用于创建不同的服务实例（如数据库服务、存储服务等），便于切换实现。

4. **单例模式**：
   - 用于全局配置、日志服务等。

5. **状态模式**：
   - 用于管理用户会话状态（在线、离线、忙碌等）。


### 服务器端线程池设计

服务器端采用固定大小的线程池（避免资源耗尽），每个线程运行一个事件循环（Event Loop）。设计如下：

- **主线程**：负责监听端口，接受新连接，并将新连接分发给工作线程。
- **I/O线程**：每个线程处理多个连接的I/O事件（使用非阻塞I/O和事件通知机制）。
- **工作线程**：处理业务逻辑（如消息转发、数据库操作等），避免阻塞I/O线程。


### 线程间通信

- **客户端**：使用信号槽机制（Qt的自动连接方式，跨线程队列连接）。
- **服务器端**：
  - I/O线程与工作线程之间使用任务队列（生产者-消费者模型）。
  - 使用Qt的信号槽进行跨线程通知（注意：使用`Qt::QueuedConnection`）。


### 服务器端线程模型优化

1. **I/O线程**：仅负责网络数据的接收和发送，不处理业务逻辑。
2. **工作线程**：从任务队列中取出任务并执行，如消息处理、数据库操作等。
3. **数据库连接池**：每个工作线程使用独立的数据库连接，避免竞争。


### 总结

- **客户端**：使用MVVM模式分离界面与逻辑，线程池处理耗时操作，保证UI流畅。
- **服务器端**：Reactor模式处理高并发连接，线程池分离I/O和业务逻辑，任务队列实现负载均衡。

 **开发规范**
   - 遵循SOLID原则
   - 命名规范（Qt风格）
   - 代码风格统一（`.clang-format`配置文件）
   - 头文件管理（前置声明/PIMPL模式）